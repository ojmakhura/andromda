// license-header java merge-point
//
// Generated by: SessionTest.vsl in andromda-ejb3-cartridge.
//
package org.andromda.timetracker.service.test;

import java.util.Date;
import java.util.Hashtable;

import javax.naming.Context;
import javax.naming.InitialContext;

import org.andromda.timetracker.domain.Role;
import org.andromda.timetracker.security.PasswordEncoder;
import org.andromda.timetracker.service.UserDoesNotExistException;
import org.andromda.timetracker.test.EJB3Container;
import org.andromda.timetracker.vo.UserDetailsVO;
import org.andromda.timetracker.vo.UserRoleVO;
import org.andromda.timetracker.vo.UserVO;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Service test class UserServiceTest for testing with TestNG
 * Check the testng.xml for initialisation of the EJB3Container before running any tests.
 */
public class UserServiceTest
{
    private static final Log logger = LogFactory.getLog(UserServiceTest.class);
    
    @org.testng.annotations.Test
    public void testRegisterUser() 
    {
        try
        {
            org.andromda.timetracker.service.UserServiceRemote userService = (org.andromda.timetracker.service.UserServiceRemote)EJB3Container.getInitialContext("user","password").lookup("UserServiceBean/remote");
            
            // Remote testuser if it already exists
            UserVO userVO = null;
            try
            {
                userVO = userService.getUser("testuser");
                if (userVO != null && userVO.getId() > 0)
                {
                    userService.removeUser(userVO);
                }
            }
            catch (UserDoesNotExistException e)
            {
                // OK to avoid
            }
            
            // Add testuser
            UserDetailsVO udVO = new UserDetailsVO();
            udVO.setFirstName("testuser");
            udVO.setLastName("testuser");
            udVO.setEmail("test@test.com");
            udVO.setIsActive(false);
            udVO.setUsername("testuser");
            udVO.setPassword(PasswordEncoder.getMD5Base64EncodedPassword("testuser"));
            udVO.setCreationDate(new Date());

            UserRoleVO urVO = new UserRoleVO();
            urVO.setRole(Role.USER);
            
            udVO.setRoles(new UserRoleVO[]{urVO});
            
            udVO = userService.registerUser(udVO);
            
            assert udVO != null;
            assert udVO.getId() > 0;
            
            logger.info("Registered new user: " + udVO.getFirstName() + ", " + udVO.getId());
            
            // Remote testuser if it already exists
            try
            {
                userVO = userService.getUser("testuser");
                if (userVO != null && userVO.getId() > 0)
                {
                    userService.removeUser(userVO);
                }
            }
            catch (UserDoesNotExistException e)
            {
                // OK to avoid
            }

        }
        catch (Exception ex)
        {
            logger.warn("Failed test testRegisterUser()", ex);
        }
    }
    
    @org.testng.annotations.Test
    public void testGetAllUsers() 
    {
        try
        {
            org.andromda.timetracker.service.UserServiceRemote userService = (org.andromda.timetracker.service.UserServiceRemote)EJB3Container.getInitialContext("user","password").lookup("UserServiceBean/remote");
            UserVO[] users = userService.getAllUsers();
            assert users.length > 0;
            
            for (UserVO userVO : users)
            {
                logger.info("user : " + userVO.getFirstName());
            }
        }
        catch (Exception ex)
        {
            logger.warn("Failed test testGetAllUsers()", ex);
        }
    }
}