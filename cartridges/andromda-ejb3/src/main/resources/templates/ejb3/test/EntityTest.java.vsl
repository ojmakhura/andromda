#if ($umlUtils.shouldOutput($entity) && !$entity.abstract)
#parse("templates/ejb3/Globals.vm")
// license-header java merge-point
//
/**
 * Generated by test/EntityTest.java.vsl in andromda-ejb3-cartridge on $umlUtils.date.
 * This file can be safely modified. If deleted it will be regenerated.
 */
#if ($stringUtils.isNotBlank($entity.packageName))
package $entity.packageName;
#end
/**
 * TestNG Unit Test to Create and Validate and Update and Delete the $entity.fullyQualifiedName Entity
 */
#set ($generatedFile = "${stringUtils.replace($entity.fullyQualifiedName,'.','/')}EntityTest.java")

import java.util.List;
import jakarta.persistence.TypedQuery;
import org.andromda.dbtest.JPAJUnitAncestor;
import org.andromda.dbtest.Priority;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.testng.annotations.AfterClass;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeClass;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;
import org.testng.Assert;

/**
 * Create ${entity.tableName} row from ${entity.entityName} Entity
 */
public class ${entity.entityName}EntityTest extends JPAJUnitAncestor
{
#set ($entityVariable = $stringUtils.uncapitalize($entity.entityName))
    private static Logger LOGGER = LogManager.getLogger(${entity.entityName}EntityTest.class);
    /** Persisted Entity to retrieve and update and delete from */
    protected static $entity.fullyQualifiedName entity = null;

    /**
     * Creates ${entity.tableName} record. TestNG creates test group is run before retrieves and deletes.
     */
    @Test(groups = { "creates" })
#set ($priority=$entityUtils.getPriority($entity))
    @Priority(2000+$priority)
    public void testCreate${entity.entityName}()
    {
        LOGGER.info("TEST CREATE ${entity.entityName}");
        // Delete all rows from table  - avoid duplicate PK error or created record not found
        this.deleteAll();
        $entity.fullyQualifiedName $entityVariable = ${entity.entityName}Create.createEntity(this.getEm());
        LOGGER.debug("persisting " + $entityVariable);
        this.getEm().persist($entityVariable);
        int results = this.logEntities();
        // Will also fail if all rows are not deleted during setUp
        Assert.assertTrue(results > 0, "${entity.entityName} inserted but record not found");
        // Save PK for later retrieve/delete
        ${entity.entityName}EntityTest.entity = $entityVariable;
        LOGGER.info("SUCCESS: CREATED ${entity.entityName} " + $entityVariable);
    }

    /**
     * Retrieving $entity.tableName record. Run after TestNG creates test group and before deletes group.
     */
##    @Test(groups = { "retrieves" }, dependsOnGroups = { "creates" })
    @Test(groups = { "retrieves" }, ignoreMissingDependencies=true)
    @Priority(3000+$priority)
    public void testRetrieve${entity.entityName}()
    {
        LOGGER.info("TEST RETRIEVE ${entity.entityName}");
#if ($entity.compositePrimaryKeyPresent)
        $entity.fullyQualifiedEntityCompositePrimaryKeyName pk = ${entity.entityName}Create.createEntityPK(true);
#else
#set ($identifier = $entity.identifier)
##        // $identifier.fullyQualifiedName $identifier.otherEnd.one2one $identifier.otherEnd.owning $identifier.type.fullyQualifiedName $identifier.type.identifier.type $identifier
#if ($identifier.type.identifier.type && $identifier.otherEnd.owning)
#set ($identifier = $identifier.type.identifier)
#end
#set ($constructor=$umlUtils.createConstructor($identifier, false, $entity))
        $identifier.type.fullyQualifiedName pk = $constructor;
#end
        $entity.entityName $entityVariable = this.getEm().find(${entity.entityName}.class, pk);
        if (${entityVariable}==null)
        {
            LOGGER.info("$entity.entityName not found for Primary Key value: " + pk + ", findingFirst Entity");
            ${entityVariable} = ${entity.entityName}Create.findFirst(this.getEm());
        }
        else
        {
            LOGGER.info("SUCCESS: RETRIEVED $entity.entityName: " + $entityVariable);
        }
    }

    /**
     * Deleting $entity.tableName record. Run after TestNG creates and retrieves test group.
     */
##    @Test(groups = { "deletes" }, dependsOnGroups = { "retrieves" })
    @Test(groups = { "deletes" }, ignoreMissingDependencies=true)
    @Priority(5000+$priority)
    public void testDelete${entity.entityName}()
    {
        LOGGER.info("TEST DELETE ${entity.entityName}");
        $entity.entityName $entityVariable = ${entity.entityName}Create.findFirst(this.getEm());
        if (!this.getEm().contains($entityVariable))
        {
            LOGGER.info("merging ${entity.entityName}: " + $entityVariable);
            $entityVariable = this.getEm().merge($entityVariable);
        }
        LOGGER.info("deleting $entity.entityName: " + $entityVariable);
        this.getEm().remove($entityVariable);
        LOGGER.info("SUCCESS: DELETED $entity.entityName");
    }

    /**
     * Find All Entities ${entity.entityName} - run only against test DB
     * @return ${entity.entityName}
     */
    public List<${entity.entityName}> findAll()
    {
        TypedQuery<${entity.entityName}> query = this.getEm().createNamedQuery("${entity.entityName}.findAll", ${entity.entityName}.class);
        List<${entity.entityName}> results = query.getResultList();
        return results;
    }

    /*
     * Return a persisted Entity ${entity.entityName} with all attributes and associations set
     * Used to set persistent association relationships in related entities.
     * Called by test delete method - this method should not be a test method
     * @return ${entity.entityName}
    public ${entity.entityName} findFirst()
    {
        ${entity.entityName} $entityVariable = null;
        List<${entity.entityName}> results = findAll();
        if (results.size() > 0)
        {
            $entityVariable = results.get(0);
        }
        else
        {
            $entityVariable = ${entity.entityName}Create.createEntity(this.getEm());
            this.getEm().persist($entityVariable);
        }
        return $entityVariable;
    }
     */

    /**
     * Add any custom code to be executed once before any tests are executed
     */
    @Override
    @BeforeClass(alwaysRun=true)
    public void setUpBeforeClass()
    {
        super.setUpBeforeClass();
        // Insert code here to be executed before any tests are run
    }

    /**
     * Add any custom code to be executed once after all tests are executed
     */
    @Override
    @AfterClass(alwaysRun=true)
    public void tearDownAfterClass()
    {
        super.tearDownAfterClass();
        // Insert code here to be executed after tests are complete
        super.closeAll();
    }

    /**
     * Add any custom code to be executed before each tests are executed
     */
    @Override
    @BeforeMethod(alwaysRun=true)
    public void setUp()
    {
        super.setUp();
    }

    /**
     * Add any custom code to be executed after each tests are executed
     */
    @Override
    @AfterMethod(alwaysRun=true)
    public void tearDown()
    {
        super.tearDown();
    }

    /**
     * Unit test Constructor with no arguments
     */
    public ${entity.entityName}EntityTest()
    {
        super();
        // Public no arg constructor
        this.entityName = "$entity.entityName";
        this.table = "$entity.tableName";
    }

    /**
     * Unit test Constructor with test case name
     * @param name test case name
     */
    public ${entity.entityName}EntityTest(final String name)
    {
        super(name);
        this.entityName = "$entity.entityName";
        this.table = "$entity.tableName";
    }
}
#end
