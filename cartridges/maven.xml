<project default="install"
	     xmlns:j="jelly:core"
  		 xmlns:ant="jelly:ant"
  		 xmlns:maven="jelly:maven"
  		 xmlns:javadoc="javadoc"
  		 xmlns:jxr="jxr">
  		 
  	<!-- ==================================================================
  			 Installs all libraries in the local repository                                                    
  		 ================================================================== -->
  	<goal name="install">
		<attainGoal name="multiproject:install"/>	
  	</goal> 
  		 
  	<j:set var="andromda.metafacade.generated.dir" value="${maven.build.src}/andromda/meta"/>
  	<j:set var="andromda.metafacade.manual.dir" value="${maven.src.dir}/facades/manual"/>
  		 
    <preGoal name="java:compile"> 
   		<attainGoal name="generate-source"/>
    </preGoal>
    
    <preGoal name="site:run-reports">
    	<attainGoal name="generate-source"/>
    </preGoal>
    
  	<!-- ==================================================================
  			 Generates the source required to build the cartridges.                                                   
  		 ================================================================== -->
    <goal name="generate-source">
    	<j:set var="currentBuildDir" value="${maven.build.src}"/>
    	<!-- keep the generation from executing more than once -->
    	<j:if test="${lastBuildDir != currentBuildDir}">
			<ant:available 
				file="${maven.src.dir}/uml"
				type="dir" 
				property="hasModel"/>
			
			<j:set var="skipProcessing" value="${skip.andromda.plugin.processing}"/>
			<j:if test="${!empty(hasModel) and empty(skipProcessing)}">
				<attainGoal name="andromda:run"/>
				<!-- add the paths of the generated source to the
					 maven compile path -->
				<ant:path
					id="metafacade.generated.src"
					location="${andromda.metafacade.generated.dir}"/>
				<maven:addPath
					id="maven.compile.src.set"
					refid="metafacade.generated.src"/>     		     
				<ant:path
					id="metafacade.manual.src"
					location="${andromda.metafacade.manual.dir}"/>
				<maven:addPath
					id="maven.compile.src.set"
					refid="metafacade.manual.src"/>      	
			</j:if>
		</j:if>
		<j:set var="lastBuildDir" value="${currentBuildDir}"/>
    </goal>
  		 
    <!-- ===================================================================
         Intercept the javadoc goals so that we can add the sources
         generated by AndroMDA to the javadoc sourceSet.  The javadoc plugin
         itself  really should support multiple source directories but 
         right now it doesn't so this is how we get around it.                            
         =================================================================== -->
	<preGoal name="maven-javadoc-plugin:report">
		<ant:fileset id="sourceSet" dir="${basedir}">
            <ant:include name="**/*.java"/>
        </ant:fileset> 
	</preGoal>

    <!-- ===================================================================
         Intercept the java cross reference report goals so that we can 
         add the generated AndroMDA sources to the cross reference report.   
		 The jxr plugin itself  really should support multiple source 
		 directories but right now it doesn't so this is how we get around it.              
         =================================================================== -->	
	<preGoal name="maven-jxr-plugin:report">
		<j:set var="previousSourceDirectory" value="${pom.build.sourceDirectory}"/>
		<j:set var="dummy" value="${pom.build.setSourceDirectory(basedir)}"/>
	</preGoal>
	
    <!-- ===================================================================
    	 Reset the pom.build.sourceDirectory back to the real source now
    	 that we're done with the jxr report.
         =================================================================== -->	    	
	<postGoal name="maven-jxr-plugin:report">
		<j:set var="dummy" value="${pom.build.setSourceDirectory(previousSourceDirectory)}"/>
		
		<!-- move the xref docs to the correct location -->
		<j:set var="jxrDestDir" value="${maven.docs.dest}/xref"/>
		<j:set var="javaSourceJxr" value="${jxrDestDir}/src/java"/>
		<j:set var="manualSourceJxr" value="${jxrDestDir}/src/facades/manual"/>
		<j:set var="generatedSourceJxr" value="${jxrDestDir}/target/src/andromda/meta"/>
		<ant:available 
			property="javaJxrPresent" 
			file="${javaSourceJxr}"/>  
		<ant:available 
			property="manualJxrPresent" 
			file="${manualSourceJxr}"/>   
		<ant:available 
			property="generatedJxrPresent" 
			file="${generatedSourceJxr}"/>  
		<ant:move todir="${jxrDestDir}">
			<j:if test="${javaJxrPresent}">
				<ant:fileset dir="${javaSourceJxr}"/>
			</j:if>			
			<j:if test="${manualJxrPresent}">
				<ant:fileset dir="${manualSourceJxr}"/>
			</j:if>
			<j:if test="${generatedJxrPresent}">
				<ant:fileset dir="${generatedSourceJxr}"/>
			</j:if>
		</ant:move>
	</postGoal>
  		 
</project>


